# Semana 14 - Despliegue de Aplicaciones Next.js en Vercel

## Introducción

Vercel es una plataforma de despliegue optimizada para aplicaciones frontend, especialmente diseñada para frameworks como Next.js. En esta guía aprenderás cómo desplegar tu aplicación Next.js en Vercel de manera eficiente y profesional.

## Prerrequisitos

Antes de comenzar, asegúrate de tener:

- [x] Una aplicación Next.js funcional
- [x] Cuenta en [GitHub](https://github.com)
- [x] Cuenta en [Vercel](https://vercel.com)
- [x] Git instalado en tu sistema
- [x] Node.js (versión 18 o superior)

!!! tip "Recomendación"
    Si aún no tienes una aplicación Next.js, puedes crear una rápidamente con:
    ```bash
    npx create-next-app@latest mi-app
    cd mi-app
    ```

## Paso 1: Preparar tu Proyecto

### 1.1 Verificar la Configuración de Next.js

Asegúrate de que tu `package.json` contenga los scripts necesarios:

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  }
}
```

### 1.2 Configurar el Archivo next.config.js (Opcional)

Si necesitas configuraciones específicas, crea o modifica `next.config.js`:

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone', // Para optimizar el despliegue
  images: {
    domains: ['ejemplo.com'], // Dominios permitidos para imágenes
  },
  env: {
    CUSTOM_KEY: process.env.CUSTOM_KEY,
  },
}

module.exports = nextConfig
```

## Paso 2: Subir el Código a GitHub

### 2.1 Inicializar Git (si no está inicializado)

```bash
git init
git add .
git commit -m "Initial commit"
```

### 2.2 Crear Repositorio en GitHub

1. Ve a [GitHub](https://github.com) y crea un nuevo repositorio
2. **No** inicialices con README, .gitignore o licencia si ya tienes código local

### 2.3 Conectar y Subir el Código

```bash
git remote add origin https://github.com/tu-usuario/tu-repositorio.git
git branch -M main
git push -u origin main
```

## Paso 3: Desplegar en Vercel

### 3.1 Método 1: Desde la Web de Vercel

1. **Accede a Vercel**: Ve a [vercel.com](https://vercel.com) e inicia sesión
2. **Importar Proyecto**: Haz clic en "New Project"
3. **Conectar GitHub**: Autoriza a Vercel para acceder a tus repositorios
4. **Seleccionar Repositorio**: Elige el repositorio de tu aplicación Next.js
5. **Configurar Despliegue**:
   - **Project Name**: Nombre de tu proyecto
   - **Framework Preset**: Next.js (se detecta automáticamente)
   - **Root Directory**: `./` (por defecto)
   - **Build Command**: `npm run build` (por defecto)
   - **Output Directory**: `.next` (por defecto)

6. **Deploy**: Haz clic en "Deploy"

### 3.2 Método 2: Usando Vercel CLI

```bash
# Instalar Vercel CLI globalmente
npm i -g vercel

# Iniciar sesión
vercel login

# Desplegar desde el directorio del proyecto
vercel

# Para despliegues de producción
vercel --prod
```

!!! success "¡Listo!"
    Tu aplicación estará disponible en una URL como: `https://tu-proyecto.vercel.app`

## Paso 4: Configurar Variables de Entorno

### 4.1 En el Dashboard de Vercel

1. Ve a tu proyecto en el dashboard de Vercel
2. Navega a **Settings** → **Environment Variables**
3. Agrega tus variables:
   - **Name**: Nombre de la variable (ej: `DATABASE_URL`)
   - **Value**: Valor de la variable
   - **Environment**: Production, Preview, Development

### 4.2 Ejemplo de Variables Comunes

```bash
# Variables de base de datos
DATABASE_URL=postgresql://usuario:password@host:puerto/database
MONGODB_URI=mongodb+srv://usuario:password@cluster.mongodb.net/database

# APIs externas
NEXT_PUBLIC_API_URL=https://api.miservicio.com
STRIPE_SECRET_KEY=sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...

# Autenticación
NEXTAUTH_SECRET=tu-secreto-super-seguro
NEXTAUTH_URL=https://tu-dominio.vercel.app
```

!!! warning "Importante"
    - Variables que empiecen con `NEXT_PUBLIC_` serán visibles en el cliente
    - Nunca expongas claves secretas con el prefijo `NEXT_PUBLIC_`

## Paso 5: Configuraciones Avanzadas

### 5.1 Dominios Personalizados

1. **Agregar Dominio**:
   - Ve a **Settings** → **Domains**
   - Agrega tu dominio personalizado
   - Configura los DNS según las instrucciones

2. **Configuración DNS**:
   ```
   Tipo: CNAME
   Nombre: www (o @)
   Valor: cname.vercel-dns.com
   ```

### 5.2 Redirects y Rewrites

En `next.config.js`:

```javascript
module.exports = {
  async redirects() {
    return [
      {
        source: '/old-page',
        destination: '/new-page',
        permanent: true,
      },
    ]
  },
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: 'https://api.externa.com/:path*',
      },
    ]
  },
}
```

### 5.3 Headers de Seguridad

```javascript
module.exports = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
        ],
      },
    ]
  },
}
```

## Paso 6: Monitoreo y Optimización

### 6.1 Analytics de Vercel

```javascript
// pages/_app.js o app/layout.js
import { Analytics } from '@vercel/analytics/react';

export default function App({ Component, pageProps }) {
  return (
    <>
      <Component {...pageProps} />
      <Analytics />
    </>
  );
}
```

### 6.2 Speed Insights

```javascript
import { SpeedInsights } from '@vercel/speed-insights/next';

export default function App({ Component, pageProps }) {
  return (
    <>
      <Component {...pageProps} />
      <SpeedInsights />
    </>
  );
}
```

## Automatización con GitHub Actions

### 6.1 Despliegue Automático

Vercel se integra automáticamente con GitHub para:

- **Push a main**: Despliega a producción
- **Pull Requests**: Crea preview deployments
- **Commits**: Genera builds automáticos

### 6.2 Configuración Personalizada

Crea `.github/workflows/vercel.yml`:

```yaml
name: Vercel Production Deployment
env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
on:
  push:
    branches:
      - main
jobs:
  Deploy-Production:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      - name: Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy Project Artifacts to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
```

## Solución de Problemas Comunes

### Error: "Module not found"

```bash
# Limpiar caché y reinstalar dependencias
rm -rf .next node_modules package-lock.json
npm install
npm run build
```

### Error de Variables de Entorno

1. Verifica que las variables estén configuradas en Vercel
2. Asegúrate de usar el prefijo correcto (`NEXT_PUBLIC_` para cliente)
3. Redespliega después de agregar variables

### Problemas de Imágenes

```javascript
// next.config.js
module.exports = {
  images: {
    domains: ['tu-dominio.com'],
    formats: ['image/webp', 'image/avif'],
  },
}
```



