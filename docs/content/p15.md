# Semana 15 - Axios en Next.js con TypeScript

## Introducción

Axios es una librería HTTP que facilita el consumo de APIs en aplicaciones web. Aunque Next.js incluye `fetch`, Axios ofrece ventajas como interceptores, cancelación de solicitudes y manejo de errores más consistente. En esta guía verás cómo integrar Axios en un proyecto Next.js con TypeScript, crear una instancia reusable, tipar respuestas y consumir APIs desde cliente y servidor.

## Prerrequisitos

- Proyecto Next.js con TypeScript
- Node.js 18+
- Cuenta de API o endpoints disponibles (propios o externos)

Instala Axios:

```bash
npm i axios
```

!!! tip "Estructura sugerida"
    Coloca utilidades compartidas en `src/lib` y servicios en `src/services`.

## Configurar instancia de Axios

Crea `src/lib/axios.ts` con una instancia centralizada e interceptores:

```ts
// src/lib/axios.ts
import axios, { AxiosError, AxiosInstance } from 'axios'

export const apiBaseURL = process.env.NEXT_PUBLIC_API_URL || 'https://jsonplaceholder.typicode.com'

const axiosInstance: AxiosInstance = axios.create({
  baseURL: apiBaseURL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
})

// Interceptor de solicitudes: añade token si existe
axiosInstance.interceptors.request.use((config) => {
  // Ejemplo: obtener token desde localStorage o cookies
  const token = typeof window !== 'undefined' ? localStorage.getItem('token') : undefined
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// Interceptor de respuestas: manejo de errores
axiosInstance.interceptors.response.use(
  (response) => response,
  (error: AxiosError) => {
    // Puedes loguear o transformar el error
    if (error.response?.status === 401) {
      // opcional: redirigir al login o refrescar token
    }
    return Promise.reject(error)
  }
)

export default axiosInstance
```

## Tipado de respuestas

Define tipos para respuestas y datos:

```ts
// src/types/api.ts
export type ApiResponse<T> = {
  data: T
  message?: string
}

export type Post = {
  userId: number
  id: number
  title: string
  body: string
}
```

## Consumo en Cliente (CSR) con TypeScript

Ejemplo con `useEffect` y cancelación usando `AbortController`:

```tsx
// src/app/posts/page.tsx (App Router, Client Component)
'use client'

import { useEffect, useState } from 'react'
import axiosInstance from '@/lib/axios'
import type { ApiResponse, Post } from '@/types/api'

export default function PostsPage() {
  const [posts, setPosts] = useState<Post[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    const controller = new AbortController()

    async function load() {
      try {
        setLoading(true)
        setError(null)
        const res = await axiosInstance.get<ApiResponse<Post[]>>('/posts', {
          signal: controller.signal,
        })
        // Si tu API devuelve directamente un arreglo, usa: axiosInstance.get<Post[]>('/posts')
        const data = Array.isArray(res.data as any) ? (res.data as any) : (res.data as ApiResponse<Post[]>).data
        setPosts(data)
      } catch (err: unknown) {
        setError(err instanceof Error ? err.message : 'Error desconocido')
      } finally {
        setLoading(false)
      }
    }

    load()
    return () => controller.abort()
  }, [])

  if (loading) return <p>Cargando...</p>
  if (error) return <p style={{ color: 'crimson' }}>Error: {error}</p>

  return (
    <div>
      <h1>Posts</h1>
      <ul>
        {posts.map((p) => (
          <li key={p.id}>
            <strong>{p.title}</strong>
            <p>{p.body}</p>
          </li>
        ))}
      </ul>
    </div>
  )
}
```

!!! warning "Variables públicas"
    Usa `NEXT_PUBLIC_` para variables que necesitas en el cliente. Las variables sin ese prefijo no están disponibles en el navegador.

## Crear API interna con Next.js (App Router)

Puedes crear endpoints internos y consumirlos con Axios. Ejemplo:

```ts
// src/app/api/posts/route.ts
import { NextResponse } from 'next/server'

export async function GET() {
  const data = [
    { id: 1, userId: 1, title: 'Hola', body: 'Contenido' },
    { id: 2, userId: 1, title: 'Mundo', body: 'Más contenido' },
  ]
  return NextResponse.json(data)
}

export async function POST(req: Request) {
  const body = await req.json()
  // Aquí guardarías en BD; devolvemos eco
  return NextResponse.json({ ok: true, data: body }, { status: 201 })
}
```

Consumir el endpoint interno desde cliente:

```tsx
// src/app/internal/page.tsx
'use client'

import { useEffect, useState } from 'react'
import axiosInstance from '@/lib/axios'
import type { Post } from '@/types/api'

export default function InternalPage() {
  const [posts, setPosts] = useState<Post[]>([])

  useEffect(() => {
    axiosInstance.get<Post[]>('/api/posts').then((res) => setPosts(res.data))
  }, [])

  return (
    <ul>
      {posts.map((p) => (
        <li key={p.id}>{p.title}</li>
      ))}
    </ul>
  )
}
```

## Manejo de errores con `isAxiosError`

```ts
import axios, { isAxiosError } from 'axios'

async function getUser(id: string) {
  try {
    const res = await axios.get(`/users/${id}`)
    return res.data
  } catch (err) {
    if (isAxiosError(err)) {
      const status = err.response?.status
      const message = err.response?.data?.message || err.message
      throw new Error(`HTTP ${status ?? 'NA'}: ${message}`)
    }
    throw err
  }
}
```

## Variables de entorno

Ejemplo `.env.local`:

```env
NEXT_PUBLIC_API_URL=https://jsonplaceholder.typicode.com
```
