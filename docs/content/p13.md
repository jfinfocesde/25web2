# Semana 13 - Next.js con TypeScript, Fetch y MockAPI

## Introducción

En esta semana aprenderemos a integrar Next.js con TypeScript para realizar peticiones HTTP usando fetch y MockAPI. Crearemos un servicio centralizado para manejar todas las peticiones y implementaremos operaciones CRUD completas.

## Configuración Inicial

### 1. Configuración de MockAPI

Primero, ve a [MockAPI.io](https://mockapi.io) y crea una cuenta gratuita. Luego:

1. Crea un nuevo proyecto
2. Crea un endpoint llamado `users` con los siguientes campos:
   - `id` (number, auto-increment)
   - `name` (string)
   - `email` (string)
   - `avatar` (string, URL de imagen)
   - `createdAt` (datetime)

Tu URL base será algo como: `https://[tu-id].mockapi.io/api/v1/`

### 2. Estructura del Proyecto

```
src/
├── lib/
│   └── api.ts          # Servicio para peticiones
├── types/
│   └── user.ts         # Interfaces TypeScript
├── components/
│   ├── UserList.tsx    # Lista de usuarios
│   ├── UserForm.tsx    # Formulario de usuario
│   └── UserCard.tsx    # Tarjeta de usuario
└── app/
    ├── page.tsx        # Página principal
    └── users/
        └── page.tsx    # Página de usuarios
```

## Implementación

### 1. Interfaces TypeScript

Primero, definamos las interfaces para nuestros datos:

```typescript
// src/types/user.ts
export interface User {
  id: string;
  name: string;
  email: string;
  avatar: string;
  createdAt: string;
}

export interface CreateUserData {
  name: string;
  email: string;
  avatar?: string;
}

export interface UpdateUserData extends Partial<CreateUserData> {}

export interface ApiResponse<T> {
  data?: T;
  error?: string;
  loading: boolean;
}
```

### 2. Servicio API Centralizado

Creamos un servicio que maneje todas las peticiones HTTP:

```typescript
// src/lib/api.ts
import { User, CreateUserData, UpdateUserData } from '@/types/user';

const API_BASE_URL = 'https://[tu-id].mockapi.io/api/v1';

class ApiService {
  private async request<T>(
    endpoint: string,
    options: RequestInit = {}
  ): Promise<T> {
    const url = `${API_BASE_URL}${endpoint}`;
    
    const config: RequestInit = {
      headers: {
        'Content-Type': 'application/json',
        ...options.headers,
      },
      ...options,
    };

    try {
      const response = await fetch(url, config);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('API request failed:', error);
      throw error;
    }
  }

  // Obtener todos los usuarios
  async getUsers(): Promise<User[]> {
    return this.request<User[]>('/users');
  }

  // Obtener un usuario por ID
  async getUserById(id: string): Promise<User> {
    return this.request<User>(`/users/${id}`);
  }

  // Crear un nuevo usuario
  async createUser(userData: CreateUserData): Promise<User> {
    return this.request<User>('/users', {
      method: 'POST',
      body: JSON.stringify({
        ...userData,
        avatar: userData.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${userData.name}`,
      }),
    });
  }

  // Actualizar un usuario
  async updateUser(id: string, userData: UpdateUserData): Promise<User> {
    return this.request<User>(`/users/${id}`, {
      method: 'PUT',
      body: JSON.stringify(userData),
    });
  }

  // Eliminar un usuario
  async deleteUser(id: string): Promise<void> {
    return this.request<void>(`/users/${id}`, {
      method: 'DELETE',
    });
  }

  // Buscar usuarios por nombre
  async searchUsers(query: string): Promise<User[]> {
    return this.request<User[]>(`/users?search=${encodeURIComponent(query)}`);
  }
}

export const apiService = new ApiService();
```

### 3. Hook Personalizado para Estado

Creamos un hook para manejar el estado de las peticiones:

```typescript
// src/hooks/useApi.ts
import { useState, useEffect } from 'react';
import { ApiResponse } from '@/types/user';

export function useApi<T>(
  apiCall: () => Promise<T>,
  dependencies: any[] = []
): ApiResponse<T> {
  const [data, setData] = useState<T | undefined>(undefined);
  const [error, setError] = useState<string | undefined>(undefined);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let isMounted = true;

    const fetchData = async () => {
      try {
        setLoading(true);
        setError(undefined);
        const result = await apiCall();
        
        if (isMounted) {
          setData(result);
        }
      } catch (err) {
        if (isMounted) {
          setError(err instanceof Error ? err.message : 'Error desconocido');
        }
      } finally {
        if (isMounted) {
          setLoading(false);
        }
      }
    };

    fetchData();

    return () => {
      isMounted = false;
    };
  }, dependencies);

  return { data, error, loading };
}
```

### 4. Componente UserCard

```typescript
// src/components/UserCard.tsx
import { User } from '@/types/user';
import { apiService } from '@/lib/api';

interface UserCardProps {
  user: User;
  onDelete: (id: string) => void;
  onEdit: (user: User) => void;
}

export default function UserCard({ user, onDelete, onEdit }: UserCardProps) {
  const handleDelete = async () => {
    if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
      try {
        await apiService.deleteUser(user.id);
        onDelete(user.id);
      } catch (error) {
        alert('Error al eliminar el usuario');
      }
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
      <div className="flex items-center space-x-4">
        <img
          src={user.avatar}
          alt={user.name}
          className="w-16 h-16 rounded-full object-cover"
        />
        <div className="flex-1">
          <h3 className="text-lg font-semibold text-gray-900">{user.name}</h3>
          <p className="text-gray-600">{user.email}</p>
          <p className="text-sm text-gray-500">
            Creado: {new Date(user.createdAt).toLocaleDateString()}
          </p>
        </div>
      </div>
      
      <div className="mt-4 flex space-x-2">
        <button
          onClick={() => onEdit(user)}
          className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
        >
          Editar
        </button>
        <button
          onClick={handleDelete}
          className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
        >
          Eliminar
        </button>
      </div>
    </div>
  );
}
```

### 5. Componente UserForm

```typescript
// src/components/UserForm.tsx
import { useState } from 'react';
import { User, CreateUserData } from '@/types/user';
import { apiService } from '@/lib/api';

interface UserFormProps {
  user?: User;
  onSubmit: (user: User) => void;
  onCancel: () => void;
}

export default function UserForm({ user, onSubmit, onCancel }: UserFormProps) {
  const [formData, setFormData] = useState({
    name: user?.name || '',
    email: user?.email || '',
    avatar: user?.avatar || '',
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      let result: User;
      
      if (user) {
        // Actualizar usuario existente
        result = await apiService.updateUser(user.id, formData);
      } else {
        // Crear nuevo usuario
        result = await apiService.createUser(formData);
      }
      
      onSubmit(result);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Error al guardar');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-lg p-6 w-full max-w-md">
        <h2 className="text-xl font-bold mb-4">
          {user ? 'Editar Usuario' : 'Crear Usuario'}
        </h2>
        
        {error && (
          <div className="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded">
            {error}
          </div>
        )}
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Nombre
            </label>
            <input
              type="text"
              required
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Email
            </label>
            <input
              type="email"
              required
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Avatar URL (opcional)
            </label>
            <input
              type="url"
              value={formData.avatar}
              onChange={(e) => setFormData({ ...formData, avatar: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          
          <div className="flex space-x-3 pt-4">
            <button
              type="submit"
              disabled={loading}
              className="flex-1 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {loading ? 'Guardando...' : (user ? 'Actualizar' : 'Crear')}
            </button>
            <button
              type="button"
              onClick={onCancel}
              className="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400"
            >
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```

### 6. Componente UserList

```typescript
// src/components/UserList.tsx
import { useState } from 'react';
import { User } from '@/types/user';
import { useApi } from '@/hooks/useApi';
import { apiService } from '@/lib/api';
import UserCard from './UserCard';
import UserForm from './UserForm';

export default function UserList() {
  const [users, setUsers] = useState<User[]>([]);
  const [showForm, setShowForm] = useState(false);
  const [editingUser, setEditingUser] = useState<User | undefined>(undefined);
  const [searchQuery, setSearchQuery] = useState('');
  
  const { data, error, loading } = useApi(() => apiService.getUsers());

  // Actualizar la lista local cuando se cargan los datos
  useState(() => {
    if (data) {
      setUsers(data);
    }
  }, [data]);

  const handleUserSubmit = (user: User) => {
    if (editingUser) {
      // Actualizar usuario existente
      setUsers(users.map(u => u.id === user.id ? user : u));
    } else {
      // Agregar nuevo usuario
      setUsers([user, ...users]);
    }
    setShowForm(false);
    setEditingUser(undefined);
  };

  const handleUserDelete = (id: string) => {
    setUsers(users.filter(u => u.id !== id));
  };

  const handleUserEdit = (user: User) => {
    setEditingUser(user);
    setShowForm(true);
  };

  const handleSearch = async () => {
    if (searchQuery.trim()) {
      try {
        const results = await apiService.searchUsers(searchQuery);
        setUsers(results);
      } catch (error) {
        console.error('Error en búsqueda:', error);
      }
    } else {
      // Recargar todos los usuarios
      if (data) {
        setUsers(data);
      }
    }
  };

  if (loading) {
    return (
      <div className="flex justify-center items-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="text-center text-red-600 p-4">
        <p>Error al cargar usuarios: {error}</p>
        <button 
          onClick={() => window.location.reload()}
          className="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
        >
          Reintentar
        </button>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto p-6">
      <div className="mb-6">
        <h1 className="text-3xl font-bold text-gray-900 mb-4">
          Gestión de Usuarios
        </h1>
        
        <div className="flex flex-col sm:flex-row gap-4 mb-6">
          <div className="flex-1 flex gap-2">
            <input
              type="text"
              placeholder="Buscar usuarios..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <button
              onClick={handleSearch}
              className="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
            >
              Buscar
            </button>
          </div>
          
          <button
            onClick={() => setShowForm(true)}
            className="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors"
          >
            Nuevo Usuario
          </button>
        </div>
      </div>

      {users.length === 0 ? (
        <div className="text-center text-gray-500 py-12">
          <p className="text-xl">No hay usuarios disponibles</p>
          <p className="mt-2">Crea el primer usuario para comenzar</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {users.map((user) => (
            <UserCard
              key={user.id}
              user={user}
              onDelete={handleUserDelete}
              onEdit={handleUserEdit}
            />
          ))}
        </div>
      )}

      {showForm && (
        <UserForm
          user={editingUser}
          onSubmit={handleUserSubmit}
          onCancel={() => {
            setShowForm(false);
            setEditingUser(undefined);
          }}
        />
      )}
    </div>
  );
}
```

### 7. Página Principal

```typescript
// src/app/page.tsx
import Link from 'next/link';

export default function Home() {
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-4xl mx-auto py-12 px-6">
        <div className="text-center">
          <h1 className="text-4xl font-bold text-gray-900 mb-8">
            Next.js + TypeScript + MockAPI
          </h1>
          <p className="text-xl text-gray-600 mb-12">
            Tutorial completo de integración con fetch y manejo de estado
          </p>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="bg-white rounded-lg shadow-md p-6">
              <h2 className="text-2xl font-semibold mb-4">Características</h2>
              <ul className="text-left space-y-2 text-gray-600">
                <li>✅ TypeScript con interfaces tipadas</li>
                <li>✅ Servicio API centralizado</li>
                <li>✅ Operaciones CRUD completas</li>
                <li>✅ Manejo de errores y loading</li>
                <li>✅ Búsqueda en tiempo real</li>
                <li>✅ UI responsive con Tailwind</li>
              </ul>
            </div>
            
            <div className="bg-white rounded-lg shadow-md p-6">
              <h2 className="text-2xl font-semibold mb-4">Tecnologías</h2>
              <ul className="text-left space-y-2 text-gray-600">
                <li>🚀 Next.js 14</li>
                <li>📘 TypeScript</li>
                <li>🌐 Fetch API</li>
                <li>🎨 Tailwind CSS</li>
                <li>📡 MockAPI.io</li>
                <li>🔄 React Hooks</li>
              </ul>
            </div>
          </div>
          
          <div className="mt-12">
            <Link
              href="/users"
              className="inline-block bg-blue-500 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-blue-600 transition-colors"
            >
              Ver Demo de Usuarios
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
}
```

### 8. Página de Usuarios

```typescript
// src/app/users/page.tsx
import UserList from '@/components/UserList';

export default function UsersPage() {
  return (
    <div className="min-h-screen bg-gray-50">
      <UserList />
    </div>
  );
}
```

## Configuración Adicional

### 1. Tailwind CSS

Asegúrate de tener Tailwind CSS configurado en tu proyecto:

```bash
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
```

### 2. Variables de Entorno

Crea un archivo `.env.local`:

```env
NEXT_PUBLIC_API_BASE_URL=https://[tu-id].mockapi.io/api/v1
```

Y actualiza el servicio API:

```typescript
const API_BASE_URL = process.env.NEXT_PUBLIC_API_BASE_URL || 'https://[tu-id].mockapi.io/api/v1';
```

## Mejores Prácticas Implementadas

### 1. Separación de Responsabilidades
- **Tipos**: Interfaces TypeScript centralizadas
- **Servicios**: Lógica de API separada
- **Componentes**: Componentes reutilizables y enfocados
- **Hooks**: Lógica de estado personalizada

### 2. Manejo de Errores
- Try-catch en todas las peticiones
- Estados de error en la UI
- Mensajes informativos para el usuario

### 3. Experiencia de Usuario
- Estados de carga (loading)
- Confirmaciones para acciones destructivas
- Feedback visual inmediato
- Búsqueda en tiempo real

### 4. TypeScript
- Interfaces bien definidas
- Tipado estricto en todas las funciones
- Generics para reutilización de código

### 5. Performance
- Componentes optimizados
- Manejo eficiente del estado
- Cleanup de efectos

## Ejercicios Propuestos

1. **Paginación**: Implementa paginación en la lista de usuarios
2. **Filtros**: Agrega filtros por fecha de creación
3. **Validación**: Implementa validación de formularios con Zod
4. **Cache**: Agrega cache local con localStorage
5. **Optimistic Updates**: Implementa actualizaciones optimistas

## Conclusión

Este tutorial demuestra una implementación completa y profesional de Next.js con TypeScript, integrando MockAPI para operaciones CRUD. El código es escalable, mantenible y sigue las mejores prácticas de desarrollo moderno.

La arquitectura propuesta permite:
- Fácil mantenimiento y extensión
- Reutilización de componentes
- Manejo robusto de errores
- Excelente experiencia de usuario
- Código tipado y seguro